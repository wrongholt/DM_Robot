{"version":3,"file":"AlexaSFBRequestHandler.js","sourceRoot":"","sources":["../../src/handler/AlexaSFBRequestHandler.ts"],"names":[],"mappings":"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","sourcesContent":["\nimport { HandlerInput, RequestHandler } from 'ask-sdk-core';\nimport { Response, Slot } from 'ask-sdk-model';\nimport { ACEDriver, UserInput, StoryMetadata, ABCImportPlugin, Choice, StoryStateHelper, Slot as ABCSlot, DriverExtension, ImporterExtension, InstructionExtension } from '@alexa-games/sfb-f';\nimport { CoreExtensionLoader } from './CoreExtensionLoader';\nimport { ConfigAccessor } from '../configAccessor';\n\nimport * as path from 'path';\n\ntype ExtensionType = DriverExtension | ImporterExtension | InstructionExtension;\nexport interface SFBHandlerConfig {\n    locale: string;\n    story: StoryMetadata;\n    pollyVoiceConfig: any;\n    defaultVoiceConfig: any;\n    attributeTableName: any;\n}\n\n\nexport class SFBRequestHandler implements RequestHandler {\n\tconstructor(protected config: SFBHandlerConfig, protected customExtensions: ExtensionType[],\n\t\tprotected configAccessor: ConfigAccessor, protected projectDir: string) {\n    }\n\n\tcanHandle(handlerInput : HandlerInput): boolean {\n\t\treturn true;\n    }\n\n    getTableName(): string {\n\t\treturn this.config.attributeTableName;\n    }\n\n\tasync handle(handlerInput : HandlerInput): Promise<Response> {\n\t\t// Load the story metadata\n\t\tconst storyData: StoryMetadata = this.config.story;\n\n\t\t// Load persistent attributes (previous state)\n\t\tlet gameState: any;\n\n\t\ttry {\n\t\t\tgameState = await handlerInput.attributesManager.getPersistentAttributes();\n\t\t} catch (error) {\n\t\t\treturn this.buildPersistentAttributeErrorResponse(error, handlerInput);\n\t\t}\n\n\t\t// Set up import plugins used (if any)\n\t\tlet customImportPlugins: ABCImportPlugin[] = [];\n\n\t\t// Set up custom extensions\t\t\n\t\t//TODO fix path\n\t\tlet extensionLoader: CoreExtensionLoader = new CoreExtensionLoader(this.config.locale, this.configAccessor, {\n\t\t\tcontentDir: path.resolve(this.projectDir, \"res\", this.config.locale),\n\t\t\thandlerInput: handlerInput\n\t\t});\n\n\t\tconst customExtensions = this.customExtensions.concat(extensionLoader.getDriverExtensions());\n\n\t\tlet userInput: UserInput = {\n\t\t\thandlerInput: handlerInput\n\t\t}\n\t\t//this.parseAsUserInput(handlerInput, extensionLoader.monetizationExtension, sessionAttributes);\n\n\t\t// Set up the ABC Story Driver\n\t\tlet storyDriver: ACEDriver = new ACEDriver(storyData, customImportPlugins, customExtensions, this.config.pollyVoiceConfig, this.config.locale);\n\n        // Configure default polly narrator\n        const NARRATOR: any = this.config.defaultVoiceConfig;\n\t\tif (NARRATOR && this.config.defaultVoiceConfig.enabled) {\n\t\t\tstoryDriver.configureDefaultPollyNarrator(NARRATOR.name, NARRATOR.pitch, NARRATOR.rate, NARRATOR.volume);\n\t\t\tstoryDriver.turnOnDefaultPolly();\n\t\t} else {\n\t\t\tstoryDriver.turnOffDefaultPolly();\n\t\t}\n\n\t\t/*\n\t\t* RUN Content\n\t\t*/\n\t\t// Identify Alexa Specific \"Pause\" intents\n\t\tlet exitingIntents: boolean = this.isPausingRequest(handlerInput);\n\n\t\t// Run the story\n\t\tlet stopChoice: Choice | null = StoryStateHelper.getChoiceByUserInput(gameState, userInput, this.config.locale);\n\n\t\tif (exitingIntents && (stopChoice == null || stopChoice.utterances.includes(\"*\"))) {\n\t\t\tawait storyDriver.pauseStory(userInput, gameState);\n\t\t} else {\n\t\t\tawait storyDriver.resumeStory(userInput, gameState);\n\t\t}\n\t\n\t\t// Save the story state for the session\n\t\thandlerInput.attributesManager.setPersistentAttributes(storyDriver.getCurrentStoryState());\n\t\tawait handlerInput.attributesManager.savePersistentAttributes();\n\t\t\n\t\tconst response = handlerInput.responseBuilder.getResponse();\n\n\t\t/**\n\t\t * Some fundamental Alexa Response rules.. .which should be handled by ASK.\n\t\t */\n\t\tif (response.directives) {\n\t\t\tfor (let directive of response.directives) {\n\t\t\t\tif (directive.type === \"Connections.SendRequest\") {\n\t\t\t\t\t// should end sesison has to be TRUE when sending Connections.SendRequest response.\n\t\t\t\t\tresponse.shouldEndSession = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (response.shouldEndSession && response.reprompt) {\n\t\t\t// cannot have reprompt when shouldEndSession is true.\n\t\t\tdelete response.reprompt;\n\t\t}\n\t\treturn response;\n\t}\n\n\tprotected isPausingRequest(handlerInput: HandlerInput): boolean {\n\t\tif (handlerInput.requestEnvelope.request.type === \"SessionEndedRequest\") {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (handlerInput.requestEnvelope.request.type === 'IntentRequest') {\n\t\t\tconst intent = handlerInput.requestEnvelope.request.intent.name;\n\n\t\t\treturn intent == \"SessionEndedRequest\" || intent == \"AMAZON.StopIntent\" || intent == \"AMAZON.PauseIntent\" || intent == \"AMAZON.CancelIntent\"\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tprivate buildPersistentAttributeErrorResponse(error: any, handlerInput: HandlerInput): Response {\n\t\tlet err: string = error.toString();\n\t\tif (err.match(new RegExp(\"is not authorized to perform\", \"gi\")) != null) {\n\t\t\treturn handlerInput.responseBuilder\n\t\t\t\t.speak(\"Could not create or access your DynamoDB Table. Please verify that your IAM role has a Full Access permission to use DynamoDB.\")\n\t\t\t\t.getResponse();\n\t\t} else if (err.match(new RegExp(\"Requested resource not found\", \"gi\")) != null) {\n\t\t\treturn handlerInput.responseBuilder\n\t\t\t\t.speak(\"A DynamoDB Table for this skill is being created. Please try again in 5 minutes.\")\n\t\t\t\t.getResponse();\n\t\t} else {\n\t\t\treturn handlerInput.responseBuilder\n\t\t\t\t.speak(\"Something went wrong while loading your progress. Try again later, and if the problem persists please contact the skill publisher.\")\n\t\t\t\t.getResponse();\n\t\t}\n\t}\n}\n\n"]}